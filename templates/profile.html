{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>

    <div class="row">
        <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è -->
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
                </div>
                <div class="card-body">
                    <form id="profileForm">
                        <div class="mb-3">
                            <label class="form-label text-muted">–õ–æ–≥–∏–Ω</label>
                            <input type="text" class="form-control" id="username" disabled>
                            <div class="form-text">–õ–æ–≥–∏–Ω –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å.</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">–ò–º—è</label>
                                <input type="text" class="form-control" id="first_name">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">–§–∞–º–∏–ª–∏—è</label>
                                <input type="text" class="form-control" id="last_name">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">–†–æ–ª—å</label>
                            <span class="badge bg-info" id="role">user</span>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å -->
        <div class="col-md-6">
            <!-- –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è -->
            <div class="card shadow-sm mb-4 border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h5>
                </div>
                <div class="card-body">
                    <form id="passwordForm">
                        <div class="mb-3">
                            <label class="form-label">–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å</label>
                            <input type="password" class="form-control" id="old_password" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                            <input type="password" class="form-control" id="new_password" required minlength="6">
                        </div>
                        <button type="submit" class="btn btn-warning">–û–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                    </form>
                </div>
            </div>

            <!-- –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞ -->
            <div class="card shadow-sm border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">–û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h5>
                </div>
                <div class="card-body">
                    <p>–£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—é –≤—Å–µ—Ö –≤–∞—à–∏—Ö –æ—Ç—á–µ—Ç–æ–≤. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
                    <button onclick="deleteAccount()" class="btn btn-outline-danger w-100">–£–¥–∞–ª–∏—Ç—å –º–æ–π –∞–∫–∫–∞—É–Ω—Ç</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", async function() {
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        try {
            const response = await fetch('/users/me', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if (response.ok) {
                const user = await response.json();
                document.getElementById('username').value = user.username;
                document.getElementById('email').value = user.email;
                document.getElementById('first_name').value = user.first_name || '';
                document.getElementById('last_name').value = user.last_name || '';
                document.getElementById('role').innerText = user.role;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                window.currentUserId = user.id;
            } else {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
                window.location.href = '/login';
            }
        } catch (e) {
            console.error(e);
        }
    });

    // 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
    document.getElementById('profileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const token = localStorage.getItem('access_token');

        const payload = {
            email: document.getElementById('email').value,
            first_name: document.getElementById('first_name').value,
            last_name: document.getElementById('last_name').value
        };

        const response = await fetch('/users/me', {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token 
            },
            body: JSON.stringify(payload)
        });

        if (response.ok) alert('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!');
        else alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è');
    });

    // 3. –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è
    document.getElementById('passwordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const token = localStorage.getItem('access_token');
        
        const payload = {
            old_password: document.getElementById('old_password').value,
            new_password: document.getElementById('new_password').value
        };

        const response = await fetch('/users/password', {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token 
            },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            alert('–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
            document.getElementById('passwordForm').reset();
        } else {
            const err = await response.json();
            alert('–û—à–∏–±–∫–∞: ' + err.detail);
        }
    });

    // 4. –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞
    async function deleteAccount() {
        if (!confirm('–í—ã –¢–û–ß–ù–û —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞.')) return;
        
        const token = localStorage.getItem('access_token');
        const userId = window.currentUserId;

        const response = await fetch(`/users/${userId}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
        });

        if (response.status === 204) {
            alert('–ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª–µ–Ω. –î–æ —Å–≤–∏–¥–∞–Ω–∏—è.');
            localStorage.removeItem('access_token');
            window.location.href = '/register';
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞');
        }
    }
</script>
{% endblock %}
