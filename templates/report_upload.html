{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞</h2>

    <form id="uploadForm">
        
        <!-- –ë–õ–û–ö –ó–ê–ì–†–£–ó–ö–ò EXCEL -->
        <div class="card mb-4 border-primary shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">–®–∞–≥ 1. –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</h5>
            </div>
            <div class="card-body bg-light">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –±–∞–ª–∞–Ω—Å–∞ (.xlsx, .xls)</label>
                        <input type="file" class="form-control" id="excelFile" accept=".xlsx, .xls">
                        <div class="form-text">–°–∏—Å—Ç–µ–º–∞ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π—Ç–∏ –∫–æ–¥—ã —Å—Ç—Ä–æ–∫ (1100, 1200...) –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É –Ω–∏–∂–µ.</div>
                    </div>
                    <div class="col-md-4 text-end">
                        <!-- –°–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                        <div id="excelLoading" class="spinner-border text-primary" role="status" style="display: none;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –®–ê–ü–ö–ê: –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∏ –ü–µ—Ä–∏–æ–¥ -->
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h5 class="card-title mb-3">–®–∞–≥ 2. –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="form-label fw-bold">–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</label>
                        <input type="text" class="form-control form-control-lg" id="organization_name" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">–ü–µ—Ä–∏–æ–¥</label>
                        <input type="text" class="form-control form-control-lg" id="period" placeholder="2024 –≥–æ–¥" required>
                    </div>
                </div>
            </div>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ò –î–ê–ù–ù–´–• -->
        <h5 class="mb-3">–®–∞–≥ 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h5>
        <ul class="nav nav-tabs" id="reportTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active fw-bold" id="assets-tab" data-bs-toggle="tab" data-bs-target="#assets" type="button">1. –ê–∫—Ç–∏–≤—ã</button>
            </li>
            <li class="nav-item">
                <button class="nav-link fw-bold" id="liabilities-tab" data-bs-toggle="tab" data-bs-target="#liabilities" type="button">2. –ü–∞—Å—Å–∏–≤—ã</button>
            </li>
            <li class="nav-item">
                <button class="nav-link fw-bold" id="profit-tab" data-bs-toggle="tab" data-bs-target="#profit" type="button">3. –§–∏–Ω. —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
            </li>
        </ul>

        <div class="tab-content p-4 border border-top-0 bg-white shadow-sm mb-5" id="myTabContent">
            
            <!-- === 1. –ê–ö–¢–ò–í–´ === -->
            <div class="tab-pane fade show active" id="assets" role="tabpanel" data-section="assets">
                <h5 class="border-bottom pb-2 mb-3 text-primary">–í–Ω–µ–æ–±–æ—Ä–æ—Ç–Ω—ã–µ –∞–∫—Ç–∏–≤—ã</h5>
                <div class="row g-3 mb-3 align-items-end">
                    <div class="col-md-6"><label class="form-label text-muted">1110. –ù–µ–º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ –∞–∫—Ç–∏–≤—ã</label><input type="number" class="form-control" id="intangible_assets"></div>
                    <div class="col-md-6"><label class="form-label text-muted">1150. –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞</label><input type="number" class="form-control" id="fixed_assets"></div>
                    <div class="col-md-12"><label class="form-label fw-bold">1100. –ò–¢–û–ì–û –ü–û –†–ê–ó–î–ï–õ–£ I</label><input type="number" step="0.01" class="form-control border-primary bg-light" id="total_non_current_assets" required></div>
                </div>

                <h5 class="border-bottom pb-2 mb-3 mt-4 text-primary">–û–±–æ—Ä–æ—Ç–Ω—ã–µ –∞–∫—Ç–∏–≤—ã</h5>
                <div class="row g-3 mb-3 align-items-end">
                    <div class="col-md-6"><label class="form-label text-muted">1210. –ó–∞–ø–∞—Å—ã</label><input type="number" class="form-control" id="inventory"></div>
                    <div class="col-md-6"><label class="form-label text-muted">1230. –î–µ–±–∏—Ç–æ—Ä—Å–∫–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å</label><input type="number" class="form-control" id="accounts_receivable"></div>
                    <div class="col-md-6"><label class="form-label text-muted">1250. –î–µ–Ω–µ–∂–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞</label><input type="number" class="form-control" id="cash_and_equivalents"></div>
                    <div class="col-md-12"><label class="form-label fw-bold">1200. –ò–¢–û–ì–û –ü–û –†–ê–ó–î–ï–õ–£ II</label><input type="number" step="0.01" class="form-control border-primary bg-light" id="total_current_assets" required></div>
                </div>
                <div class="text-end mt-4"><button type="button" class="btn btn-primary px-4" onclick="switchTab('liabilities-tab')">–î–∞–ª–µ–µ &rarr;</button></div>
            </div>

            <!-- === 2. –ü–ê–°–°–ò–í–´ === -->
            <div class="tab-pane fade" id="liabilities" role="tabpanel" data-section="liabilities">
                <h5 class="border-bottom pb-2 mb-3 text-primary">–ö–∞–ø–∏—Ç–∞–ª –∏ —Ä–µ–∑–µ—Ä–≤—ã</h5>
                <div class="row g-3 mb-3">
                    <div class="col-md-6"><label class="form-label text-muted">1370. –ù–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å</label><input type="number" class="form-control" id="retained_earnings"></div>
                    <div class="col-md-6"><label class="form-label fw-bold">1300. –ò–¢–û–ì–û –ö–ê–ü–ò–¢–ê–õ</label><input type="number" step="0.01" class="form-control border-primary bg-light" id="total_capital" required></div>
                </div>

                <h5 class="border-bottom pb-2 mb-3 mt-4 text-primary">–û–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞</h5>
                <div class="row g-3 mb-3">
                    <div class="col-md-6"><label class="form-label text-muted">1410. –ó–∞–µ–º–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ (–¥–æ–ª–≥–æ—Å—Ä–æ–∫)</label><input type="number" class="form-control" id="long_term_borrowings"></div>
                    <div class="col-md-6"><label class="form-label fw-bold">1400. –ò–¢–û–ì–û –î–û–õ–ì–û–°–†–û–ß–ù–´–ï</label><input type="number" step="0.01" class="form-control border-primary bg-light" id="total_long_term_liabilities" required></div>
                    <div class="col-12"><hr class="text-muted"></div>
                    <div class="col-md-6"><label class="form-label text-muted">1510. –ó–∞–µ–º–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ (–∫—Ä–∞—Ç–∫–æ—Å—Ä–æ–∫)</label><input type="number" class="form-control" id="short_term_borrowings"></div>
                    <div class="col-md-6"><label class="form-label text-muted">1520. –ö—Ä–µ–¥–∏—Ç–æ—Ä—Å–∫–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å</label><input type="number" class="form-control" id="accounts_payable"></div>
                    <div class="col-md-12"><label class="form-label fw-bold">1500. –ò–¢–û–ì–û –ö–†–ê–¢–ö–û–°–†–û–ß–ù–´–ï</label><input type="number" step="0.01" class="form-control border-primary bg-light" id="total_short_term_liabilities" required></div>
                </div>
                <div class="text-end mt-4">
                    <button type="button" class="btn btn-secondary me-2" onclick="switchTab('assets-tab')">&larr; –ù–∞–∑–∞–¥</button>
                    <button type="button" class="btn btn-primary px-4" onclick="switchTab('profit-tab')">–î–∞–ª–µ–µ &rarr;</button>
                </div>
            </div>

            <!-- === 3. –§–ò–ù–ê–ù–°–û–í–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´ === -->
            <div class="tab-pane fade" id="profit" role="tabpanel" data-section="profit_loss">
                <h5 class="border-bottom pb-2 mb-3 text-primary">–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h5>
                <div class="row g-3 mb-3">
                    <div class="col-md-6"><label class="form-label fw-bold">2110. –í—ã—Ä—É—á–∫–∞</label><input type="number" class="form-control" id="revenue" required></div>
                    <div class="col-md-6"><label class="form-label">2120. –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–¥–∞–∂</label><input type="number" class="form-control" id="cost_of_sales"></div>
                    <div class="col-md-6"><label class="form-label">2200. –ü—Ä–∏–±—ã–ª—å –æ—Ç –ø—Ä–æ–¥–∞–∂</label><input type="number" class="form-control" id="sales_profit"></div>
                    <div class="col-md-6"><label class="form-label">2300. –ü—Ä–∏–±—ã–ª—å –¥–æ –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è</label><input type="number" class="form-control" id="profit_before_tax"></div>
                </div>
                <div class="alert alert-success mt-4">
                    <div class="mb-0">
                        <label class="form-label fw-bold fs-5">2400. –ß–ò–°–¢–ê–Ø –ü–†–ò–ë–´–õ–¨ (–£–ë–´–¢–û–ö)</label>
                        <input type="number" step="0.01" class="form-control form-control-lg border-success" id="net_profit" required>
                    </div>
                </div>
                <div class="d-grid gap-2 mt-5">
                    <button type="submit" class="btn btn-success btn-lg py-3 shadow">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑</button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    function switchTab(tabId) {
        const triggerEl = document.querySelector(`#${tabId}`);
        bootstrap.Tab.getOrCreateInstance(triggerEl).show();
        triggerEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function collectData(sectionId) {
        const container = document.querySelector(`div[data-section="${sectionId}"]`);
        const inputs = container.querySelectorAll('input');
        const data = {};
        inputs.forEach(input => {
            data[input.id] = input.value ? parseFloat(input.value) : 0;
        });
        return data;
    }

    // === –õ–û–ì–ò–ö–ê –ó–ê–ì–†–£–ó–ö–ò EXCEL ===
    document.getElementById('excelFile').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const spinner = document.getElementById('excelLoading');
        spinner.style.display = 'block';

        const formData = new FormData();
        formData.append('file', file);

        const token = localStorage.getItem('access_token');

        try {
            const response = await fetch('/reports/parse_excel', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token 
                },
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                
                let filledCount = 0;
                for (const [key, value] of Object.entries(data)) {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = value;
                        filledCount++;
                    }
                }
                alert(`–§–∞–π–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω! –ó–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–ª–µ–π: ${filledCount}`);
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ Excel.');
            }
        } catch (err) {
            console.error(err);
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        } finally {
            spinner.style.display = 'none';
            e.target.value = ''; 
        }
    });

    // === –õ–û–ì–ò–ö–ê –û–¢–ü–†–ê–í–ö–ò –§–û–†–ú–´ (–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ) ===
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        const payload = {
            organization_name: document.getElementById('organization_name').value,
            period: document.getElementById('period').value,
            assets: collectData('assets'),
            liabilities: collectData('liabilities'),
            profit_loss: collectData('profit_loss')
        };

        try {
            const response = await fetch('/reports/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                window.location.href = '/';
            } else {
                const err = await response.json();
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + JSON.stringify(err));
            }
        } catch (error) {
            console.error(error);
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        }
    });
</script>
{% endblock %}
