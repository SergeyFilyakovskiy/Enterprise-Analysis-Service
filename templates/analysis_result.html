{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h2>
    <div>
        <a href="/{{ report_id }}/export/pdf" class="btn btn-outline-danger" target="_blank">üìÑ –°–∫–∞—á–∞—Ç—å PDF</a>
        <a href="/" class="btn btn-outline-secondary">‚Üê –ù–∞–∑–∞–¥</a>
    </div>
</div>

<!-- –ë–õ–û–ö –ó–ê–ì–†–£–ó–ö–ò -->
<div id="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2">–í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞—Å—á–µ—Ç—ã...</p>
</div>

<!-- –ë–õ–û–ö –†–ï–ó–£–õ–¨–¢–ê–¢–û–í (–°–∫—Ä—ã—Ç) -->
<div id="results" style="display: none;">
    
    <!-- 1. –õ–ò–ö–í–ò–î–ù–û–°–¢–¨ -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">1. –ê–Ω–∞–ª–∏–∑ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="alert alert-secondary text-center">
                        <h6>–¢–µ–∫—É—â–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å</h6>
                        <h3 id="current_liquidity">-</h3>
                        <small>–ù–æ—Ä–º–∞: > 2.0</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-secondary text-center">
                        <h6>–ë—ã—Å—Ç—Ä–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å</h6>
                        <h3 id="quick_liquidity">-</h3>
                        <small>–ù–æ—Ä–º–∞: > 1.0</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-secondary text-center">
                        <h6>–ê–±—Å–æ–ª—é—Ç–Ω–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å</h6>
                        <h3 id="absolute_liquidity">-</h3>
                        <small>–ù–æ—Ä–º–∞: > 0.2</small>
                    </div>
                </div>
            </div>
            <p class="text-muted fst-italic" id="liquidity_conclusion">
                <!-- –°—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç –≤—ã–≤–æ–¥ -->
            </p>
        </div>
    </div>

    <!-- 2. –†–ï–ù–¢–ê–ë–ï–õ–¨–ù–û–°–¢–¨ -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">2. –ê–Ω–∞–ª–∏–∑ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏</h5>
        </div>
        <div class="card-body">
            <table class="table">
                <thead><tr><th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th></tr></thead>
                <tbody>
                    <tr><td>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–∞–∂ (ROS)</td><td id="ros" class="fw-bold">-</td></tr>
                    <tr><td>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–æ–≤ (ROA)</td><td id="roa" class="fw-bold">-</td></tr>
                    <tr><td>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –∫–∞–ø–∏—Ç–∞–ª–∞ (ROE)</td><td id="roe" class="fw-bold">-</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 3. –ë–ê–ù–ö–†–û–¢–°–¢–í–û -->
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4 border-warning">
                <div class="card-body text-center">
                    <h5 class="card-title text-warning">–ú–æ–¥–µ–ª—å –ê–ª—å—Ç–º–∞–Ω–∞ (Z-Score)</h5>
                    <h2 class="display-4" id="altman_score">-</h2>
                    <div id="altman_badge" class="badge bg-secondary fs-6">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-4 border-warning">
                <div class="card-body text-center">
                    <h5 class="card-title text-warning">–ú–æ–¥–µ–ª—å –¢–∞—Ñ—Ñ–ª–µ—Ä–∞</h5>
                    <h2 class="display-4" id="taffler_score">-</h2>
                    <div id="taffler_badge" class="badge bg-secondary fs-6">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    document.addEventListener("DOMContentLoaded", async function() {
        const reportId = {{ report_id }}; // Jinja –≤—Å—Ç–∞–≤–∏—Ç ID
        const token = localStorage.getItem('access_token');

        try {
            // –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä—É—á–∫—É –∞–Ω–∞–ª–∏–∑–∞ (–Ω–µ HTML, –∞ JSON API)
            // –ü—Ä–æ–≤–µ—Ä—å, –µ—Å—Ç—å –ª–∏ —É —Ç–µ–±—è —Ä—É—á–∫–∞ GET /analysis/{id} –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∞—è JSON
            const response = await fetch(`/analysis/${reportId}/json`, { ... });

            if (response.ok) {
                const data = await response.json();
                renderResults(data);
            } else {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏–∑–∞');
            }
        } catch (e) {
            console.error(e);
        } finally {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results').style.display = 'block';
        }
    });

    function renderResults(data) {
        // –õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å
        document.getElementById('current_liquidity').innerText = data.liquidity.current_ratio.toFixed(2);
        document.getElementById('quick_liquidity').innerText = data.liquidity.quick_ratio.toFixed(2);
        document.getElementById('absolute_liquidity').innerText = data.liquidity.absolute_ratio.toFixed(2);

        // –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å
        document.getElementById('ros').innerText = data.profitability.return_on_sales.toFixed(2) + '%';
        document.getElementById('roa').innerText = data.profitability.return_on_assets.toFixed(2) + '%';
        document.getElementById('roe').innerText = data.profitability.return_on_equity.toFixed(2) + '%';

        // –ê–ª—å—Ç–º–∞–Ω
        const z = data.bankruptcy_altman.z_score;
        document.getElementById('altman_score').innerText = z.toFixed(2);
        const altBadge = document.getElementById('altman_badge');
        altBadge.innerText = data.bankruptcy_altman.risk_assessment;
        
        if (data.bankruptcy_altman.risk_assessment.includes("–ù–∏–∑–∫–∏–π")) altBadge.className = "badge bg-success fs-6";
        else if (data.bankruptcy_altman.risk_assessment.includes("–í—ã—Å–æ–∫–∏–π")) altBadge.className = "badge bg-danger fs-6";
        else altBadge.className = "badge bg-warning text-dark fs-6";

        // –¢–∞—Ñ—Ñ–ª–µ—Ä (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ)
        const t = data.bankruptcy_taffler.t_score;
        document.getElementById('taffler_score').innerText = t.toFixed(2);
        const tafBadge = document.getElementById('taffler_badge');
        tafBadge.innerText = data.bankruptcy_taffler.risk_assessment;
    }
</script>
{% endblock %}
