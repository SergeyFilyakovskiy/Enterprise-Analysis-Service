{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h2>
    <div>
        <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ JS —Å —Ç–æ–∫–µ–Ω–æ–º -->
        <button onclick="downloadPDF({{ report_id }})" class="btn btn-outline-danger">
            üìÑ –°–∫–∞—á–∞—Ç—å PDF
        </button>
        <a href="/" class="btn btn-outline-secondary">‚Üê –ù–∞–∑–∞–¥</a>
    </div>
</div>

<!-- –ë–õ–û–ö –ó–ê–ì–†–£–ó–ö–ò -->
<div id="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2">–í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞—Å—á–µ—Ç—ã...</p>
</div>

<!-- –ë–õ–û–ö –†–ï–ó–£–õ–¨–¢–ê–¢–û–í (–°–∫—Ä—ã—Ç) -->
<div id="results" style="display: none;">
    
    <!-- 1. –õ–ò–ö–í–ò–î–ù–û–°–¢–¨ -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">1. –ê–Ω–∞–ª–∏–∑ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="alert alert-secondary text-center">
                        <h6>–¢–µ–∫—É—â–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å</h6>
                        <h3 id="current_liquidity">-</h3>
                        <small>–ù–æ—Ä–º–∞: > 2.0</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-secondary text-center">
                        <h6>–ë—ã—Å—Ç—Ä–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å</h6>
                        <h3 id="quick_liquidity">-</h3>
                        <small>–ù–æ—Ä–º–∞: > 1.0</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-secondary text-center">
                        <h6>–ê–±—Å–æ–ª—é—Ç–Ω–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å</h6>
                        <h3 id="absolute_liquidity">-</h3>
                        <small>–ù–æ—Ä–º–∞: > 0.2</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. –†–ï–ù–¢–ê–ë–ï–õ–¨–ù–û–°–¢–¨ -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">2. –ê–Ω–∞–ª–∏–∑ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏</h5>
        </div>
        <div class="card-body">
            <table class="table">
                <thead><tr><th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th></tr></thead>
                <tbody>
                    <tr><td>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–∞–∂ (ROS)</td><td id="ros" class="fw-bold">-</td></tr>
                    <tr><td>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–æ–≤ (ROA)</td><td id="roa" class="fw-bold">-</td></tr>
                    <tr><td>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –∫–∞–ø–∏—Ç–∞–ª–∞ (ROE)</td><td id="roe" class="fw-bold">-</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 3. –ë–ê–ù–ö–†–û–¢–°–¢–í–û -->
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4 border-warning">
                <div class="card-body text-center">
                    <h5 class="card-title text-warning">–ú–æ–¥–µ–ª—å –ê–ª—å—Ç–º–∞–Ω–∞ (Z-Score)</h5>
                    <h2 class="display-4" id="altman_score">-</h2>
                    <div id="altman_badge" class="badge bg-secondary fs-6">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-4 border-warning">
                <div class="card-body text-center">
                    <h5 class="card-title text-warning">–ú–æ–¥–µ–ª—å –¢–∞—Ñ—Ñ–ª–µ—Ä–∞</h5>
                    <h2 class="display-4" id="taffler_score">-</h2>
                    <div id="taffler_badge" class="badge bg-secondary fs-6">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // === 1. –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ê–ù–ê–õ–ò–ó–ê ===
    document.addEventListener("DOMContentLoaded", async function() {
        const reportId = {{ report_id }}; 
        const token = localStorage.getItem('access_token');

        if (!token) {
            alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã!");
            window.location.href = "/login";
            return;
        }

        try {
            const response = await fetch(`/analysis/${reportId}/json`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                renderResults(data);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';
            } else {
                if (response.status === 401) {
                    alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
                    window.location.href = '/login';
                } else {
                    alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏–∑–∞: ${response.status}`);
                }
                document.getElementById('loading').style.display = 'none';
            }
        } catch (e) {
            console.error("Network Error:", e);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            document.getElementById('loading').style.display = 'none';
        }
    });

    // === 2. –§–£–ù–ö–¶–ò–Ø –û–¢–†–ò–°–û–í–ö–ò ===
    function renderResults(data) {
        const safeFixed = (val) => (val !== undefined && val !== null) ? Number(val).toFixed(2) : '-';

        document.getElementById('current_liquidity').innerText = safeFixed(data.liquidity?.current_ratio);
        document.getElementById('quick_liquidity').innerText = safeFixed(data.liquidity?.quick_ratio);
        document.getElementById('absolute_liquidity').innerText = safeFixed(data.liquidity?.absolute_ratio);

        document.getElementById('ros').innerText = safeFixed(data.profitability?.ros) + '%';
        document.getElementById('roa').innerText = safeFixed(data.profitability?.roa) + '%';
        document.getElementById('roe').innerText = safeFixed(data.profitability?.roe) + '%';

        if (data.bankruptcy_altman) {
            document.getElementById('altman_score').innerText = safeFixed(data.bankruptcy_altman.z_score || data.bankruptcy_altman.score); // –ø—Ä–æ–≤–µ—Ä–∏–ª –∏ —Ç–æ, –∏ –¥—Ä—É–≥–æ–µ
            const altBadge = document.getElementById('altman_badge');
            const risk = (data.bankruptcy_altman.risk_assessment || data.bankruptcy_altman.conclusion || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ").toLowerCase();
            altBadge.innerText = data.bankruptcy_altman.risk_assessment || data.bankruptcy_altman.conclusion;
            
            altBadge.className = "badge fs-6 " + (
                (risk.includes("–Ω–∏–∑–∫–∏–π") || risk.includes("—É—Å—Ç–æ–π—á–∏–≤–æ–µ")) ? "bg-success" :
                risk.includes("–≤—ã—Å–æ–∫–∏–π") ? "bg-danger" : "bg-warning text-dark"
            );
        }

        if (data.bankruptcy_taffler) {
            document.getElementById('taffler_score').innerText = safeFixed(data.bankruptcy_taffler.t_score || data.bankruptcy_taffler.score);
            const tafBadge = document.getElementById('taffler_badge');
            const riskT = (data.bankruptcy_taffler.risk_assessment || data.bankruptcy_taffler.conclusion || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ").toLowerCase();
            tafBadge.innerText = data.bankruptcy_taffler.risk_assessment || data.bankruptcy_taffler.conclusion;
            
            tafBadge.className = "badge fs-6 " + (
                (riskT.includes("–Ω–∏–∑–∫–∏–π") || riskT.includes("—É—Å—Ç–æ–π—á–∏–≤–æ–µ")) ? "bg-success" :
                riskT.includes("–≤—ã—Å–æ–∫–∏–π") ? "bg-danger" : "bg-warning text-dark"
            );
        }
    }

    async function downloadPDF(reportId) {
        const token = localStorage.getItem('access_token');
        if (!token) {
            alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã!");
            window.location.href = '/login';
            return;
        }

        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = "‚è≥ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ...";
        btn.disabled = true;

        try {
            const response = await fetch(`/reports/${reportId}/export/pdf`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report_${reportId}.pdf`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            } else {
                if (response.status === 401) {
                     alert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.");
                     window.location.href = '/login';
                } else {
                     alert("–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: " + response.statusText);
                }
            }
        } catch (e) {
            console.error(e);
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
</script>
{% endblock %}
